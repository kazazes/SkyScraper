version: "2.1"
networks: {}
volumes:
  influxdb-data: {}
  resin-data: {}
services:
  trunk-recorder:
    build:
      context: ./host-images/trunk-recorder
    privileged: true
    restart: "unless-stopped"
    depends_on:
      - "config"
    network_mode: host
    cpuset: 0-3
    volumes:
      - "resin-data:/data"
  config:
    build:
      context: ./host-images/config
    network_mode: host
    restart: "on-failure"
    volumes:
      - "resin-data:/data"
  influxdb:
    build:
      context: ./host-images/influxdb
    container_name: influxdb
    # privileged added so usb drive can be mounted.
    privileged: true
    volumes:
      # take care that the mount location "/mnt/influxdb" becomes overwritten
      # by the mount location specified in the influxdb Dockerfile.
      - "influxdb-data:/mnt/influxdb"
    ports:
      # The API for InfluxDB is served on port 8086
      - "8086:8086"
      - "8082:8082"
      # UDP Port
      - "8089:8089"
    restart: always
  telegraf:
    build:
      context: ./host-images/telegraf
    pid: "host"
    network_mode: "host"
    privileged: true
    labels:
      io.resin.features.balena-socket: "1"
    depends_on:
      - influxdb
    restart: always
  grafana:
    build:
      context: ./host-images/grafana
    ports:
      - "3000:3000"
    depends_on:
      - influxdb
    restart: always
  mqtt:
    image: panuwitp/mosquitto-arm
    ports:
      - "1883:1883"
  node-red:
    build:
      context: ./host-images/node-red
    volumes:
      - "resin-data:/data"
    ports:
      - "1880:1880"
    depends_on:
      - mqtt
    restart: always
  nginx:
    build:
      context: ./host-images/nginx
    depends_on:
      - grafana
      - node-red
    ports:
      - "80:80"
      - "443:443"
    restart: always
