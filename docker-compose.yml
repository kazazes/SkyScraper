version: "2.1"
networks: {}
volumes:
  resin-data: {}
services:
  trunk-recorder:
    build:
      context: ./trunk-recorder
    privileged: true
    restart: "no"
    depends_on:
      - "config"
    network_mode: host
    volumes:
      - "resin-data:/data"
    labels:
      io.resin.features.kernel-modules: "1"
      io.resin.features.firmware: "1"
      io.resin.features.dbus: "1"
      io.resin.features.supervisor-api: "1"
      io.resin.features.resin-api: "1"
  config:
    build:
      context: ./config
    network_mode: host
    restart: "no"
    volumes:
      - "resin-data:/data"
    labels:
      io.resin.features.kernel-modules: "1"
      io.resin.features.firmware: "1"
      io.resin.features.dbus: "1"
      io.resin.features.supervisor-api: "1"
      io.resin.features.resin-api: "1"
  trunk-player:
    build:
      context: ./trunk-player
    network_mode: host
    restart: "no"
    volumes:
      - "resin-data:/data"
    labels:
      io.resin.features.kernel-modules: "1"
      io.resin.features.firmware: "1"
      io.resin.features.dbus: "1"
      io.resin.features.supervisor-api: "1"
      io.resin.features.resin-api: "1"
  postgres:
    image: ./postgres
    volumes:
      - "resin-data:/data"
    restart: always
    network_mode: host
    environment:
      POSTGRES_USER: skyscraper
      POSTGRES_PASSWORD: sdr
      PGDATA: /data/postgres
    ports:
      - "5433:5432"
    labels:
      io.resin.features.kernel-modules: "1"
      io.resin.features.firmware: "1"
      io.resin.features.dbus: "1"
      io.resin.features.supervisor-api: "1"
      io.resin.features.resin-api: "1"
  nginx:
    image: nginx:latest
    ports:
      - "8000:80"
    volumes:
      - "resin-data:/data"
    network_mode: host
    environment:
      - NGINX_PORT=80
    command: /bin/sh -c "envsubst < /data/conf/nginx.conf > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
